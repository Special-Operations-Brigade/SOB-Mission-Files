missionNamespace setVariable ["_weaponConfigs", [ 
["MTI_BARM_Shotgun", "mti_factions_mag_purple_shotgun_slug", ""],
    ["mti_armoury_weapon_acpr", "mti_armoury_mag_acpr", "mti_armoury_weapons_core_Flashlight_nomodel"],
    ["mti_armoury_weapon_acpa", "mti_armoury_mag_acpa_buck", "mti_armoury_weapons_core_Flashlight_nomodel"],
    ["mti_armoury_weapon_arkanian", "mti_armoury_mag_arkanian", "3AS_Optic_Arkanian_1_F"],
    ["mti_armoury_weapon_boltblaster_base", "mti_armoury_mag_boltblaster_buck", "mti_armoury_weapons_core_HRCO_Blue"],
    ["mti_armoury_weapon_br_77_wood", "mti_armoury_mag_BR77_HP", "mti_armoury_weapons_br77_br_77_scope"],
    ["mti_armoury_weapon_btx", "mti_armoury_mag_btx", ""],
    ["mti_armoury_weapon_causality", "mti_armoury_mag_causality_precision","mti_armoury_weapons_causality_causality_scope"],
    ["mti_armoury_weapon_cinnagaran", "mti_armoury_mag_cinnagaran", "3AS_Optic_Cinnagaran_1_F"],
    ["mti_armoury_weapon_cyclone", "mti_armoury_mag_cyclone_thermal", "mti_armoury_weapons_cyclone_cyclone_scope"],
    ["mti_armoury_weapon_DC15L", "mti_armoury_mag_DC15L", "mti_armoury_weapons_core_HRCO_Red"],
    ["mti_armoury_weapon_DC15A_GL", "mti_armoury_mag_DC15A", "mti_armoury_weapons_core_HRCO_Green"],
    ["mti_armoury_weapon_DC15C", "mti_armoury_mag_DC15C", "mti_armoury_weapons_core_Holo_Red"],
    ["mti_armoury_weapon_DC15S", "mti_armoury_mag_DC15S", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_DC15A", "mti_armoury_mag_DC15A", "mti_armoury_weapons_core_HRCO_Green"],
    ["mti_armoury_weapon_DC15X", "mti_armoury_mag_DC15X", "mti_armoury_weapons_core_HLRPS_Blue"],
    ["mti_armoury_weapon_DC15C", "mti_armoury_mag_DC15C", "mti_armoury_weapons_core_Holo_Red"],
    ["mti_armoury_weapon_DC15S", "mti_armoury_mag_DC15S", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_DC15A", "mti_armoury_mag_DC15A", "mti_armoury_weapons_core_HRCO_Green"],
    ["mti_armoury_weapon_DC15X", "mti_armoury_mag_DC15X", "mti_armoury_weapons_core_HLRPS_Blue"],
    ["mti_armoury_weapon_DC15C", "mti_armoury_mag_DC15C", "mti_armoury_weapons_core_Holo_Red"],
    ["mti_armoury_weapon_DC15S", "mti_armoury_mag_DC15S", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_DC15A", "mti_armoury_mag_DC15A", "mti_armoury_weapons_core_HRCO_Green"],
    ["mti_armoury_weapon_DC15X", "mti_armoury_mag_DC15X", "mti_armoury_weapons_core_HLRPS_Blue"],
    ["mti_armoury_weapon_DC15C", "mti_armoury_mag_DC15C", "mti_armoury_weapons_core_Holo_Red"],
    ["mti_armoury_weapon_DC15S", "mti_armoury_mag_DC15S", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_DC15A", "mti_armoury_mag_DC15A", "mti_armoury_weapons_core_HRCO_Green"],
    ["mti_armoury_weapon_DC15X", "mti_armoury_mag_DC15X", "mti_armoury_weapons_core_HLRPS_Blue"],
    ["mti_armoury_weapon_DC15C", "mti_armoury_mag_DC15C", "mti_armoury_weapons_core_Holo_Red"],
    ["mti_armoury_weapon_DC15S", "mti_armoury_mag_DC15S", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_DC15A", "mti_armoury_mag_DC15A", "mti_armoury_weapons_core_HRCO_Green"],
    ["mti_armoury_weapon_DC15C", "mti_armoury_mag_DC15C", "mti_armoury_weapons_core_Holo_Red"],
    ["mti_armoury_weapon_DC15S", "mti_armoury_mag_DC15S", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_DC15A", "mti_armoury_mag_DC15A", "mti_armoury_weapons_core_HRCO_Green"],
    ["mti_armoury_weapon_DC15C", "mti_armoury_mag_DC15C", "mti_armoury_weapons_core_Holo_Red"],
    ["mti_armoury_weapon_DC15S", "mti_armoury_mag_DC15S", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_DC15A", "mti_armoury_mag_DC15A", "mti_armoury_weapons_core_HRCO_Green"],
    ["mti_armoury_weapon_DC15C", "mti_armoury_mag_DC15C", "mti_armoury_weapons_core_Holo_Red"],
    ["mti_armoury_weapon_DC15S", "mti_armoury_mag_DC15S", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_DC15A", "mti_armoury_mag_DC15A", "mti_armoury_weapons_core_HRCO_Green"],
    ["mti_armoury_weapon_DC15C", "mti_armoury_mag_DC15C", "mti_armoury_weapons_core_Holo_Red"],
    ["mti_armoury_weapon_DC15S", "mti_armoury_mag_DC15S", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_DC15A", "mti_armoury_mag_DC15A", "mti_armoury_weapons_core_HRCO_Green"],
    ["mti_armoury_weapon_DC15C", "mti_armoury_mag_DC15C", "mti_armoury_weapons_core_Holo_Red"],
    ["mti_armoury_weapon_DC15S", "mti_armoury_mag_DC15S", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_DC15A", "mti_armoury_mag_DC15A", "mti_armoury_weapons_core_HRCO_Green"],
    ["mti_armoury_weapon_cinnagaran", "mti_armoury_mag_cinnagaran", "3AS_Optic_Cinnagaran_1_F"],
    ["mti_armoury_weapon_cinnagaran", "mti_armoury_mag_cinnagaran", "3AS_Optic_Cinnagaran_1_F"],
    ["mti_armoury_weapon_cinnagaran", "mti_armoury_mag_cinnagaran", "3AS_Optic_Cinnagaran_1_F"],
    ["mti_armoury_weapon_cinnagaran", "mti_armoury_mag_cinnagaran", "3AS_Optic_Cinnagaran_1_F"],
    ["mti_factions_weapon_e5", "mti_factions_mag_ice_carbine", "mti_armoury_weapons_core_HRCO_Blue"],
    ["mti_factions_weapon_Railgun", "MTI_Factions_Rail_Blunt_Mag", ""],
    ["MTI_Factions_SpaceAR1", "MTI_Factions_spaceAR1_mag", "3AS_optic_DC15C_F"],
    ["mti_factions_weapon_acpr", "mti_factions_mag_repeater", ""],
    ["mti_factions_weapon_sbb3", "mti_factions_mag_shotgun_slug", "mti_armoury_weapons_core_HRCO_Blue"],
    ["mti_armoury_weapon_DW32S", "mti_armoury_mag_DW32S_HP", ""],
    ["mti_factions_weapon_acpr", "mti_factions_mag_repeater", ""],
    ["mti_factions_weapon_sbb3", "mti_factions_mag_shotgun_slug", "mti_armoury_weapons_core_HRCO_Blue"],
    ["mti_armoury_weapon_DW32S", "mti_armoury_mag_DW32S_HP", ""],
    ["mti_factions_weapon_acpr", "mti_factions_mag_repeater", ""],
    ["mti_factions_weapon_sbb3", "mti_factions_mag_shotgun_slug", "mti_armoury_weapons_core_HRCO_Blue"],
    ["mti_armoury_weapon_DW32S", "mti_armoury_mag_DW32S_HP", ""],
    ["mti_factions_weapon_acpr", "mti_factions_mag_repeater", ""],
    ["mti_factions_weapon_sbb3", "mti_factions_mag_shotgun_slug", "mti_armoury_weapons_core_HRCO_Blue"],
    ["mti_armoury_weapon_DW32S", "mti_armoury_mag_DW32S_HP", ""],
    ["mti_armoury_weapon_dp24", "mti_armoury_mag_dp24", "mti_armoury_weapons_core_HRCO_Blue"],
    ["mti_factions_weapon_boltblaster_shotgun", "mti_factions_mag_yellow_shotgun_slug", "Bat_Spike"],
    ["mti_factions_weapon_e5c", "mti_factions_mag_purple_carbine", ""],
    ["mti_factions_weapon_e15", "mti_factions_mag_lime_mg", ""],
    ["mti_factions_weapon_pulsebreaker", "mti_factions_mag_sniper", ""],
    ["mti_factions_weapon_ee2", "mti_factions_mag_1rd_shock", "3AS_Optic_Scope_WestarM5"],
    ["mti_armoury_weapon_zh73", "mti_armoury_mag_zh73", "mti_armoury_weapons_core_HRCO_Blue"],
    ["mti_armoury_weapon_DC19SC", "mti_armoury_mag_DC19SC", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_dp23_hp", "mti_armoury_mag_dp23_buck", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_DC19A", "mti_armoury_mag_DC15A_HP", "mti_armoury_weapons_core_HRCO_Red"],
    ["mti_factions_weapon_ee2", "mti_factions_mag_1rd_shock", "3AS_Optic_Scope_WestarM5"],
    ["mti_armoury_weapon_zh73", "mti_armoury_mag_zh73", "mti_armoury_weapons_core_HRCO_Blue"],
    ["mti_armoury_weapon_DC19SC", "mti_armoury_mag_DC19SC", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_dp23_hp", "mti_armoury_mag_dp23_buck", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_DC19A", "mti_armoury_mag_DC15A_HP", "mti_armoury_weapons_core_HRCO_Red"],
    ["mti_factions_weapon_ee2", "mti_factions_mag_1rd_shock", "3AS_Optic_Scope_WestarM5"],
    ["mti_armoury_weapon_zh73", "mti_armoury_mag_zh73", "mti_armoury_weapons_core_HRCO_Blue"],
    ["mti_armoury_weapon_DC19SC", "mti_armoury_mag_DC19SC", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_dp23_hp", "mti_armoury_mag_dp23_buck", "mti_armoury_weapons_core_HMRCO_Blue"],
    ["mti_armoury_weapon_DC19A", "mti_armoury_mag_DC15A_HP", "mti_armoury_weapons_core_HRCO_Red"],
    ["mti_factions_weapon_AT_Launcher", "mti_factions_mag_AT_Yellow", ""],
    ["mti_armoury_weapon_Firepuncher", "mti_armoury_mag_Firepuncher", ""],
    ["mti_armoury_weapon_z6_heavy", "mti_armoury_mag_z6", ""],
    ["mti_armoury_weapon_e403", "mti_armoury_mag_e403_ap", ""],
    ["mti_armoury_weapon_Verpine", "mti_armoury_mag_Verpine", "mti_armoury_weapons_verpine_Verpine_Scope"],
    ["mti_armoury_weapon_rd4", "mti_armoury_mag_rd4_3rnd", ""],
    ["mti_armoury_weapon_valken39y", "mti_armoury_mag_valken39y", "3AS_Imp_Optic_1"],
    ["mti_armoury_weapon_dc17m", "mti_armoury_mag_dc17m_ap", ""], 
    ["mti_armoury_weapon_westarm5", "mti_armoury_mag_westarm5", "3AS_Imp_Optic_4"], 
    ["mti_armoury_weapon_ls150", "mti_armoury_mag_ls150", ""],
    ["mti_armoury_weapon_t20", "mti_armoury_mag_t20", "mti_armoury_weapons_core_HRCO_Green"],
    ["mti_armoury_weapon_DC15C_GL", "mti_armoury_mag_DC15C", "mti_armoury_weapons_core_HMRCO_Blue"], 
    ["mti_armoury_weapon_Bowcaster", "mti_armoury_mag_Bowcaster_base", "mti_armoury_weapons_bowcaster_Bowcaster_Scope"], 
    ["mti_armoury_weapon_MPL", "mti_armoury_mag_40mm_AP", "mti_armoury_weapons_core_HRCO_Red"],
    ["mti_armoury_weapon_pcb_base", "mti_armoury_mag_pcb", "mti_armoury_weapons_pcb99_pcb_scope"],
    ["mti_factions_weapon_minnoch", "mti_factions_mag_yellow_extended_pistol", "optic_tws_mg"], 
    ["mti_factions_weapon_shockblaster", "MTI_Factions_Shockwave_Mag", "optic_ico_01_black_f"], 
    ["mti_armoury_weapon_DLT19", "mti_armoury_mag_DLT19", ""], 
    ["mti_armoury_weapon_epl2", "mti_armoury_mag_epl2", ""], 
    ["mti_armoury_weapon_valken38x", "mti_armoury_mag_valken38x", "mti_armoury_weapons_core_HDMS_Blue"], 
    ["mti_factions_weapon_mando_sniper", "mti_factions_mag_sniper", ""], 
    ["mti_armoury_weapon_HH12", "mti_armoury_mag_HH12_Cluster", ""], 
    ["mti_armoury_weapon_plx1", "mti_armoury_mag_plx1_at", ""], 
    ["3AS_Arkanian_Pistol_F", "3AS_8Rnd_EY40_Mag", ""]
]]; 

missionNamespace setVariable ["_items", ["ItemGPS","ItemMap","JLTS_Clone_LR_attachment","Black_WM_Rebel_bag","B_FieldPack_blk","B_CivilianBackpack_01_Everyday_Black_F","ls_backpack_chestRig","JLTS_clone_comlink","NVGoggles_OPFOR","MineDetector","ACE_NVG_Gen1","ACE_EntrenchingTool","ACE_DefusalKit","ACE_fieldDressing","mti_armoury_props_medical_bacta_patch_item_Base","mti_armoury_props_medical_bacta_patch_item_Base","mti_armoury_props_medical_Bacta_Item_1000"]];

// Add rare items array
missionNamespace setVariable ["_rareItems", ["ACE_surgicalKit","JLTS_clone_comlink","mti_armoury_equipment_custom_backpack_arc","mti_armoury_equipment_commando_backpack_rto_base","mti_armoury_equipment_commando_nvg_chip"]]; // Example rare items, replace with your own


fnc_spawnLoot = {
    // Find all buildings within 75m of any player, deduplicate
    private _allBuildings = [];
    private _playerPositions = [];
    {
        _playerPositions pushBack (getPosATL _x);
    } forEach allPlayers;
    
    // Get unique buildings within range of any player
    {
        private _nearBuildings = _x nearObjects ["Building", 75];
        _allBuildings append _nearBuildings;
    } forEach _playerPositions;
    _allBuildings = _allBuildings arrayIntersect _allBuildings;

    if (isNil "DB_globalBuildingIndex") then { DB_globalBuildingIndex = 0; };
    {
        _building = _x;
        if (isNil {_building getVariable ["DB_buildingIndex", nil]}) then {
            _building setVariable ["DB_buildingIndex", DB_globalBuildingIndex, true];
            DB_globalBuildingIndex = DB_globalBuildingIndex + 1;
        };
        _bIdx = _building getVariable ["DB_buildingIndex", -1];
        if !(_building getVariable ["hasLoot", false]) then {
            if ((_bIdx % 2) == 0) then { // Spawn loot in every 2nd building
                _positions = _building buildingPos -1;
                if (count _positions > 0) then {
                    _building setVariable ["hasLoot", true, true];
                    _pos = selectRandom _positions;
                    // Spawn a crate at this position
                    _crate = createVehicle ["mti_armoury_supplies_crate_empty", _pos, [], 0, "CAN_COLLIDE"];
                    _crate setPos _pos;
                    _crate setVariable ["isLootCrate", true, true];
                    // Make crate invincible
                    _crate allowDamage false;
                    // Fill crate with 8-15 random weapons/items (increased from 5-9)
                    _numLoot = 8 + floor random 8;
                    for "_j" from 1 to _numLoot do {
                        _itemType = selectRandom ["weapon", "item", "backpack"];
                        switch (_itemType) do {
                            case "weapon": {
                                _weaponConfig = selectRandom (missionNamespace getVariable "_weaponConfigs");
                                _weapon = _weaponConfig select 0;
                                _compatibleMag = _weaponConfig select 1;
                                _crate addWeaponCargoGlobal [_weapon, 1];
                                _crate addMagazineCargoGlobal [_compatibleMag, 2 + floor(random 4)]; // Increased ammo from 1-3 to 2-5
                            };
                            case "backpack": {
                                private _backpack = "";
                                _backpacks = ["3AS_Republic_HR_Bag","Black_WM_Rebel_bag","B_FieldPack_blk","B_CivilianBackpack_01_Everyday_Black_F","ls_backpack_chestRig","ls_backpack_mrbc","ls_mandalorianBackpack_heavy","B_TacticalPack_blk","ls_mandalorianBackpack","ls_rebelBackpack_chest_pouch","B_Carryall_blk","ls_cloneBackpack_beltbag"];
                                _rareBackpacks = ["mti_armoury_equipment_custom_backpack_arc","mti_armoury_equipment_commando_backpack_rto_base","mti_armoury_equipment_custom_backpack_fsb"];
                                
                                // 5% chance for rare backpack
                                if ((random 1) < 0.05) then {
                                    _backpack = selectRandom _rareBackpacks;
                                } else {
                                    _backpack = selectRandom _backpacks;
                                };
                                _crate addBackpackCargoGlobal [_backpack, 1];
                            };
                            case "item": {
                                // Remove backpacks from regular items array
                                _regularItems = ["ItemGPS","ItemMap","JLTS_Clone_LR_attachment","JLTS_clone_comlink","NVGoggles_OPFOR","MineDetector","ACE_NVG_Gen1","ACE_EntrenchingTool","ACE_DefusalKit","ACE_fieldDressing","mti_armoury_props_medical_bacta_patch_item_Base","mti_armoury_props_medical_bacta_patch_item_Base","mti_armoury_props_medical_Bacta_Item_1000"];
                                // 3% chance to spawn a rare item instead of a normal item (increased from 2%)
                                if ((random 1) < 0.03) then {
                                    _rareItems = ["ACE_surgicalKit","JLTS_clone_comlink","mti_armoury_equipment_commando_nvg_chip"];
                                    _rareItem = selectRandom _rareItems;
                                    _crate addItemCargoGlobal [_rareItem, 1];
                                } else {
                                    _item = selectRandom _regularItems;
                                    _crate addItemCargoGlobal [_item, 1];
                                };
                            };
                        };
                    };
                    // Start a despawn monitor for this crate
                    _despawnDistance = 100;
                    _despawnTime = 10;
                    [_crate, _despawnDistance, _despawnTime] spawn {
                        params ["_crate", "_despawnDistance", "_despawnTime"];
                        private _timer = 0;
                        while {alive _crate} do {
                            _near = allPlayers select {(_x distance _crate) < _despawnDistance};
                            if (count _near == 0) then {
                                _timer = _timer + 1;
                                if (_timer >= _despawnTime) exitWith {deleteVehicle _crate;};
                            } else {
                                _timer = 0;
                            };
                            sleep 1;
                        };
                    };
                };
            };
        };
    } forEach _allBuildings;
};

[] spawn {
    while {true} do {
        call fnc_spawnLoot;
        sleep 10; // Increase main loop delay for further performance improvement
    };
};